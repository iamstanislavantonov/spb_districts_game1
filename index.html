<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏–π</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=116bc79b-81e1-4da9-9107-738ef00abee5&lang=ru_RU"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        body, html {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background: #f0f2f5;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* –ü–∞–Ω–µ–ª—å –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
        .category-panel {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 30px;
            padding: 12px 20px;
            display: flex;
            gap: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            backdrop-filter: blur(5px);
            background: rgba(255,255,255,0.95);
        }
        
        .category-btn {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            border: none;
            font-size: 28px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .category-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .category-btn.selected {
            border: 4px solid #007aff;
            transform: scale(1.1);
        }
        
        .category-btn.dtp { background: #DB4437; color: white; }
        .category-btn.fire { background: #FF9800; color: white; }
        .category-btn.utility { background: #4285F4; color: white; }
        .category-btn.crime { background: #0F9D58; color: white; }
        .category-btn.other { background: #9C27B0; color: white; }
        
        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ */
        .hint {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            pointer-events: none;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="hint" id="hint">
        üëÜ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É
    </div>
    
    <div class="category-panel" id="categoryPanel">
        <button class="category-btn dtp" data-category="dtp">üöó</button>
        <button class="category-btn fire" data-category="fire">üî•</button>
        <button class="category-btn utility" data-category="utility">üíß</button>
        <button class="category-btn crime" data-category="crime">üöî</button>
        <button class="category-btn other" data-category="other">üìå</button>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        tg.ready();
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let map;
        let selectedCategory = null;
        let currentMarkers = [];
        
        // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
        const categories = {
            'dtp': { name: '–î–¢–ü', emoji: 'üöó', color: '#DB4437' },
            'fire': { name: '–ü–æ–∂–∞—Ä', emoji: 'üî•', color: '#FF9800' },
            'utility': { name: '–ö–æ–º–º—É–Ω–∞–ª—å–Ω–∞—è –∞–≤–∞—Ä–∏—è', emoji: 'üíß', color: '#4285F4' },
            'crime': { name: '–ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ', emoji: 'üöî', color: '#0F9D58' },
            'other': { name: '–î—Ä—É–≥–æ–µ', emoji: 'üìå', color: '#9C27B0' }
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        ymaps.ready(() => {
            map = new ymaps.Map('map', {
                center: [59.93, 30.31], // –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥
                zoom: 11,
                controls: ['zoomControl']
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            map.events.add('click', (e) => {
                if (!selectedCategory) {
                    tg.showAlert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è!');
                    return;
                }
                
                const coords = e.get('coords');
                showConfirmDialog(coords);
            });
        });
        
        // –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
                // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é
                btn.classList.add('selected');
                selectedCategory = btn.dataset.category;
                
                // –í–∏–±—Ä–∞—Ü–∏—è (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
                tg.HapticFeedback.impactOccurred('light');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                document.getElementById('hint').innerHTML = 
                    `–í—ã–±—Ä–∞–Ω–æ: ${categories[selectedCategory].emoji} ${categories[selectedCategory].name}<br>üëÜ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É`;
            });
        });
        
        // –î–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        function showConfirmDialog(coords) {
            const category = categories[selectedCategory];
            
            tg.showPopup({
                title: '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏–µ?',
                message: `${category.emoji} ${category.name}\n\n–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${coords[0].toFixed(4)}, ${coords[1].toFixed(4)}`,
                buttons: [
                    { id: 'cancel', type: 'destructive', text: '–û—Ç–º–µ–Ω–∞' },
                    { id: 'confirm', type: 'default', text: '–î–æ–±–∞–≤–∏—Ç—å' }
                ]
            }, (buttonId) => {
                if (buttonId === 'confirm') {
                    sendMarkerToBot(coords);
                }
            });
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ—Ç–∫–∏ –≤ –±–æ—Ç
        function sendMarkerToBot(coords) {
            const data = {
                action: 'add_marker',
                lat: coords[0],
                lng: coords[1],
                category: selectedCategory
            };
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram –±–æ—Ç
            tg.sendData(JSON.stringify(data));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            tg.showPopup({
                title: '‚úÖ –ú–µ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!',
                message: '–°–ø–∞—Å–∏–±–æ! –ü—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º.',
                buttons: [{ type: 'close' }]
            });
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
            selectedCategory = null;
            document.getElementById('hint').innerHTML = 'üëÜ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É';
        }
    </script>
</body>
</html>